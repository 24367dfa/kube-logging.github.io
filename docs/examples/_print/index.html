<!doctype html><html itemscope itemtype="http://schema.org/WebPage" lang="en" class="no-js">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name="generator" content="Hugo 0.110.0">
<link rel="canonical" type="text/html" href="https://kube-logging.dev/docs/examples/">
<link rel="alternate" type="text/releases" href="https://kube-logging.dev/docs/examples/releases.releases">
<meta name="robots" content="noindex, nofollow">
<link rel="shortcut icon" href="/favicons/favicon.ico">
<link rel="apple-touch-icon" href="/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/favicons/android-192x192.png" sizes="192x192">
<title>Examples | Logging operator</title><meta name="description" content="Documentation for the Logging operator">
<meta property="og:title" content="Examples">
<meta property="og:description" content="Documentation for the Logging operator">
<meta property="og:type" content="website">
<meta property="og:url" content="https://kube-logging.dev/docs/examples/"><meta property="og:site_name" content="Logging operator">
<meta itemprop="name" content="Examples">
<meta itemprop="description" content="Documentation for the Logging operator"><meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Examples">
<meta name="twitter:description" content="Documentation for the Logging operator">
<meta name="twitter:site" content="@calisti12">
<link rel="preload" href="/scss/main.min.ea124d1a5ca55adb367f0f334ac1055fd60c2385e8ffc34d5f01caac50a69f6c.css" as="style">
<link href="/scss/main.min.ea124d1a5ca55adb367f0f334ac1055fd60c2385e8ffc34d5f01caac50a69f6c.css" rel="stylesheet" integrity>
<script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK" crossorigin="anonymous"></script>
<script defer src="https://unpkg.com/lunr@2.3.9/lunr.min.js" integrity="sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli" crossorigin="anonymous"></script>
<link rel="stylesheet" href="/css/prism.css">
<script src="/js/w3.js" type="application/x-javascript"></script>
<link rel="canonical" href="https://kube-logging.dev/docs/examples/">
</head><body class="td-section">
<header>
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
<a class="navbar-brand" href="/"><span class="navbar-brand__logo navbar-logo"><svg viewBox="0 0 3237.738 490.023" id="svg142" sodipodi:docname="logo-new2.svg" inkscape:version="1.2.1 (9c6d41e4, 2022-07-14)" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape" xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd" xmlns="http://www.w3.org/2000/svg" xmlns:svg="http://www.w3.org/2000/svg"><defs id="defs146"/><sodipodi:namedview id="namedview144" pagecolor="#505050" bordercolor="#ffffff" borderopacity="1" inkscape:showpageshadow="0" inkscape:pageopacity="0" inkscape:pagecheckerboard="1" inkscape:deskcolor="#505050" showgrid="false" inkscape:zoom=".37340884" inkscape:cx="1620.208" inkscape:cy="243.70071" inkscape:window-width="705" inkscape:window-height="480" inkscape:window-x="0" inkscape:window-y="25" inkscape:window-maximized="0" inkscape:current-layer="svg142"/><g id="Group_2068" data-name="Group 2068" transform="translate(-43577.297 -34456.625)"><g id="Group_2067" data-name="Group 2067" transform="translate(27723.789 24565.273)"><path id="Path_4217" data-name="Path 4217" d="M47842.219 34024.414l-276.027 475.07h71.242l240.227-414.1z" transform="translate(-31703.996 -24123.111)" fill="#d6d7d9" stroke="#d6d7d9" stroke-width="10"/><path id="Path_4218" data-name="Path 4218" d="M47831.324 34080.781l166.754 287.355h-333.035z" transform="translate(-31640.254 -24086.76)" fill="#fff" stroke="#fff" stroke-width="10"/><path id="Path_4220" data-name="Path 4220" d="M47668.742 34274.2l-37.727 64.1h442.43l-37.156-64.1z" transform="translate(-31662.199 -23962.018)" fill="#d6d7d9" stroke="#d6d7d9" stroke-width="10"/><path id="Path_4222" data-name="Path 4222" d="M11294.989 10157.944l311.97-.01-156.218-269.074-78.621 135.83z" transform="translate(4740.338 117.39)" fill="#fff"/><path id="Path_4224" data-name="Path 4224" d="M47787.594 34159.125l-54.391 93.035h108.039z" transform="translate(-31596.297 -24036.238)" fill="#13142c" stroke="#13132d" stroke-width="10"/></g><text id="Logging_Operator" data-name="Logging Operator" transform="translate(45475.035 34799.609)" fill="#fff" font-size="267" font-family="Montserrat-Bold, Montserrat" font-weight="700" letter-spacing=".046em"><tspan x="-1339.806" y="0" id="tspan138">Logging Operator</tspan></text></g></svg></span><span class="navbar-brand__name">Logging operator</span>
<span class="font-weight-bold navbar-logo navbar-version">4.2.0</span></a>
<div class="td-navbar-nav-scroll ml-md-auto" id="main_navbar">
<ul class="navbar-nav mt-2 mt-lg-0">
<li class="nav-item mr-4 mb-2 mb-lg-0">
<a class="nav-link" href="https://github.com/kube-logging/logging-operator" target="_blank"><span>Project page</span></a>
</li><li class="nav-item mr-4 mb-2 mb-lg-0">
<a class="nav-link" href="/docs/"><span>Documentation</span></a>
</li><li class="nav-item dropdown mr-4 d-none d-lg-block">
<a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
Releases
</a>
<div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
<div w3-include-html="/docs/examples//releases.releases" w3-include-html-default='<a class="dropdown-item" href="/docs/releases.releases">Latest</a>'></div><script type="application/x-javascript">w3.includeHTML()</script>
</div></li></ul></div><div class="navbar-nav d-none d-lg-block">
<div class="td-search td-search--offline">
<div class="td-search__icon"></div><input type="search" class="td-search__input form-control" placeholder="Search this site…" aria-label="Search this site…" autocomplete="off" data-offline-search-index-json-src="/offline-search-index.30a3a631782da056f48289db470f1ef8.json" data-offline-search-base-href="/" data-offline-search-max-results="10">
</div></div></nav></header><div class="container-fluid td-outer">
<div class="td-main">
<div class="row flex-xl-nowrap">
<main class="col-12 col-md-9 col-xl-8 pl-md-5" role="main">
<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>
This is the multi-page printable view of this section.
<a href="#" onclick="return print(),!1">Click here to print</a>.
</p><p>
<a href="/docs/examples/">Return to the regular view of this page</a>.
</p></div><h1 class="title">Examples</h1><ul>
<li>1: <a href="#pg-05eacbf7a0c1b481b78d7fadf3072b45">Filter examples in Flows</a></li><li>2: <a href="#pg-40c8034365add30f05453065286935a7">Store Nginx Access Logs in Amazon CloudWatch with Logging Operator</a></li><li>3: <a href="#pg-151681c15ceae7e696e0c20fe51220fa">Splunk operator with Logging operator</a></li><li>4: <a href="#pg-256fcfd7514994ffef95721e2aab59da">Sumo Logic with Logging operator and Fluentd</a></li><li>5: <a href="#pg-abd97e700fb7a973b1dcfb4cb9aae1b4">Transport Nginx Access Logs into Kafka with Logging operator</a></li><li>6: <a href="#pg-01af43cb645f47605cedaae3bc91678b">Store Nginx Access Logs in Grafana Loki with Logging operator</a></li></ul><div class="content">
<h2 id="flow-examples">Flow examples</h2><p>The following examples show some simple flows. For more examples that use filters, see <a href="/docs/examples/filters-in-flows/">Filter examples in Flows</a>.</p><h3 id="flow-with-a-single-output">Flow with a single output</h3><p>This Flow sends every message with the <code>app: nginx</code> label to the output called <code>forward-output-sample</code>.</p><pre data-src='https://kube-logging.dev/docs/examples/logging_flow_single_output.yaml' data-download-link data-download-link-label="Download this file" $opts></pre><h3 id="flow-with-multiple-outputs">Flow with multiple outputs</h3><p>This Flow sends every message with the <code>app: nginx</code> label to the <code>gcs-output-sample</code> and <code>s3-output-example</code> outputs.</p><pre data-src='https://kube-logging.dev/docs/examples/logging_flow_multiple_output.yaml' data-download-link data-download-link-label="Download this file" $opts></pre><h2 id="logging-examples">Logging examples</h2><p>Simple <a href="/docs/logging-infrastructure/logging/">Logging</a> definition with default values.</p><pre data-src='https://kube-logging.dev/docs/examples/logging_logging_simple.yaml' data-download-link data-download-link-label="Download this file" $opts></pre><h3 id="logging-with-tls">Logging with TLS</h3><p>Simple <a href="/docs/logging-infrastructure/logging/">Logging</a> definition with <a href="/docs/logging-infrastructure/tls/">TLS encryption enabled</a>.</p><pre data-src='https://kube-logging.dev/docs/examples/logging_logging_tls.yaml' data-download-link data-download-link-label="Download this file" $opts></pre><h2 id="output-examples">Output examples</h2><h3 id="simple-file-output">Simple file output</h3><p>Defines a <a href="/docs/configuration/plugins/outputs/file/">file output</a> with timestamped log files.</p><pre data-src='https://kube-logging.dev/docs/examples/logging_output_file.yaml' data-download-link data-download-link-label="Download this file" $opts></pre><h3 id="drop-messages-into-devnull-output">Drop messages into dev/null output</h3><p>Creates a dev/null output that can be the destination of messages you want to drop explicitly.</p><div class="warning-block">
<p><strong>CAUTION:</strong></p>Messages sent to this output are irrevocably lost forever.
</div><pre data-src='https://kube-logging.dev/docs/examples/logging_output_null.yaml' data-download-link data-download-link-label="Download this file" $opts></pre><h3 id="s3-output">S3 output</h3><p>Defines an <a href="/docs/configuration/plugins/outputs/s3/">Amazon S3 output</a> to store your logs in a bucket.</p><pre data-src='https://kube-logging.dev/docs/examples/logging_output_s3.yaml' data-download-link data-download-link-label="Download this file" $opts></pre><h3 id="gcs-output">GCS output</h3><p>Defines a <a href="/docs/configuration/plugins/outputs/gcs/">Google Cloud Storage output</a> to store your logs.</p><pre data-src='https://kube-logging.dev/docs/examples/logging_output_s3.yaml' data-download-link data-download-link-label="Download this file" $opts></pre></div></div><div class="td-content" style="page-break-before:always">
<h1 id="pg-05eacbf7a0c1b481b78d7fadf3072b45">1 - Filter examples in Flows</h1><p>YAML files for simple logging flows with filter examples.</p><h2 id="geoip-filter">GeoIP filter</h2><pre data-src='https://kube-logging.dev/docs/examples/logging_flow_geoip.yaml' data-download-link data-download-link-label="Download this file" $opts></pre><h2 id="parser-and-tag-normalizer">Parser and tag normalizer</h2><pre data-src='https://kube-logging.dev/docs/examples/logging_flow_with_filters.yaml' data-download-link data-download-link-label="Download this file" $opts></pre><h2 id="dedot-filter">Dedot filter</h2><pre data-src='https://kube-logging.dev/docs/examples/logging_flow_with_dedot.yaml' data-download-link data-download-link-label="Download this file" $opts></pre><h2 id="multiple-format">Multiple format</h2><pre data-src='https://kube-logging.dev/docs/examples/logging_flow_with_multi_format.yaml' data-download-link data-download-link-label="Download this file" $opts></pre></div><div class="td-content" style="page-break-before:always">
<h1 id="pg-40c8034365add30f05453065286935a7">2 - Store Nginx Access Logs in Amazon CloudWatch with Logging Operator</h1><p align="center"><img src="../../img/nlw.png" width="340"></p><p>This guide describes how to collect application and container logs in Kubernetes using the Logging operator, and how to send them to CloudWatch.</p><p>The following figure gives you an overview about how the system works. The Logging operator collects the logs from the application, selects which logs to forward to the output, and sends the selected log messages to the output. For more details about the Logging operator, see the <a href="/docs/">Logging operator overview</a>.</p><p align="center"><img src="../../img/nginx-cloudwatch.png" width="900"></p><h2 id="deploy-the-logging-operator-and-a-demo-application">Deploy the Logging operator and a demo Application</h2><p>Install the Logging operator and a demo application using <a href="#helm">Helm</a>.</p><h3 id="helm">Deploy the Logging operator with Helm</h3><p>To install the Logging operator using Helm, complete these steps.</p><blockquote>
<p>Note: For the Helm-based installation you need Helm v3.2.1 or later.</p></blockquote><ol>
<li>
<p>Add the chart repository of the Logging operator using the following commands:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>helm repo add kube-logging https://kube-logging.dev/helm-charts
</span></span><span style="display:flex"><span>helm repo update
</span></span></code></pre></div></li><li>
<p>Install the Logging operator.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>helm upgrade --install --wait --create-namespace --namespace logging logging-operator kube-logging/logging-operator
</span></span></code></pre></div></li><li>
<p>Create AWS <code>secret</code></p><blockquote>
<p>If you have your <code>$AWS_ACCESS_KEY_ID</code> and <code>$AWS_SECRET_ACCESS_KEY</code> set you can use the following snippet.</p></blockquote><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>    kubectl -n logging create secret generic logging-cloudwatch --from-literal <span style="color:#4e9a06">&#34;awsAccessKeyId=</span><span style="color:#000">$AWS_ACCESS_KEY_ID</span><span style="color:#4e9a06">&#34;</span> --from-literal <span style="color:#4e9a06">&#34;awsSecretAccessKey=</span><span style="color:#000">$AWS_SECRET_ACCESS_KEY</span><span style="color:#4e9a06">&#34;</span>
</span></span></code></pre></div><p>Or set up the secret manually.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>    kubectl -n logging apply -f - &lt;&lt;<span style="color:#4e9a06">&#34;EOF&#34;</span>
</span></span><span style="display:flex"><span>    apiVersion: v1
</span></span><span style="display:flex"><span>    kind: Secret
</span></span><span style="display:flex"><span>    metadata:
</span></span><span style="display:flex"><span>      name: logging-cloudwatch
</span></span><span style="display:flex"><span>    type: Opaque
</span></span><span style="display:flex"><span>    data:
</span></span><span style="display:flex"><span>      awsAccessKeyId: &lt;base64encoded&gt;
</span></span><span style="display:flex"><span>      awsSecretAccessKey: &lt;base64encoded&gt;
</span></span><span style="display:flex"><span>    EOF
</span></span></code></pre></div></li><li>
<p>Create the <code>logging</code> resource.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl -n logging apply -f - &lt;&lt;<span style="color:#4e9a06">&#34;EOF&#34;</span>
</span></span><span style="display:flex"><span>apiVersion: logging.banzaicloud.io/v1beta1
</span></span><span style="display:flex"><span>kind: Logging
</span></span><span style="display:flex"><span>metadata:
</span></span><span style="display:flex"><span>  name: default-logging-simple
</span></span><span style="display:flex"><span>spec:
</span></span><span style="display:flex"><span>  fluentd: <span style="color:#ce5c00;font-weight:700">{}</span>
</span></span><span style="display:flex"><span>  fluentbit: <span style="color:#ce5c00;font-weight:700">{}</span>
</span></span><span style="display:flex"><span>  controlNamespace: logging
</span></span><span style="display:flex"><span>EOF
</span></span></code></pre></div><blockquote>
<p>Note: You can use the <code>ClusterOutput</code> and <code>ClusterFlow</code> resources only in the <code>controlNamespace</code>.</p></blockquote></li><li>
<p>Create an CloudWatch <code>output</code> definition.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl -n logging apply -f - &lt;&lt;<span style="color:#4e9a06">&#34;EOF&#34;</span>
</span></span><span style="display:flex"><span>apiVersion: logging.banzaicloud.io/v1beta1
</span></span><span style="display:flex"><span>kind: Output
</span></span><span style="display:flex"><span>metadata:
</span></span><span style="display:flex"><span> name: cloudwatch-output
</span></span><span style="display:flex"><span> namespace: logging
</span></span><span style="display:flex"><span>spec:
</span></span><span style="display:flex"><span> cloudwatch:
</span></span><span style="display:flex"><span>   aws_key_id:
</span></span><span style="display:flex"><span>     valueFrom:
</span></span><span style="display:flex"><span>       secretKeyRef:
</span></span><span style="display:flex"><span>         name: logging-cloudwatch
</span></span><span style="display:flex"><span>         key: awsAccessKeyId
</span></span><span style="display:flex"><span>   aws_sec_key:
</span></span><span style="display:flex"><span>     valueFrom:
</span></span><span style="display:flex"><span>       secretKeyRef:
</span></span><span style="display:flex"><span>         name: logging-cloudwatch
</span></span><span style="display:flex"><span>         key: awsSecretAccessKey
</span></span><span style="display:flex"><span>   log_group_name: operator-log-group
</span></span><span style="display:flex"><span>   log_stream_name: operator-log-stream
</span></span><span style="display:flex"><span>   region: us-east-1
</span></span><span style="display:flex"><span>   auto_create_stream: <span style="color:#204a87">true</span>
</span></span><span style="display:flex"><span>   buffer:
</span></span><span style="display:flex"><span>     timekey: 30s
</span></span><span style="display:flex"><span>     timekey_wait: 30s
</span></span><span style="display:flex"><span>     timekey_use_utc: <span style="color:#204a87">true</span>
</span></span><span style="display:flex"><span>EOF
</span></span></code></pre></div><blockquote>
<p>Note: In production environment, use a longer <code>timekey</code> interval to avoid generating too many objects.</p></blockquote></li><li>
<p>Create a <code>flow</code> resource.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl -n logging apply -f - &lt;&lt;<span style="color:#4e9a06">&#34;EOF&#34;</span>
</span></span><span style="display:flex"><span>apiVersion: logging.banzaicloud.io/v1beta1
</span></span><span style="display:flex"><span>kind: Flow
</span></span><span style="display:flex"><span>metadata:
</span></span><span style="display:flex"><span>  name: cloudwatch-flow
</span></span><span style="display:flex"><span>spec:
</span></span><span style="display:flex"><span>  filters:
</span></span><span style="display:flex"><span>    - tag_normaliser: <span style="color:#ce5c00;font-weight:700">{}</span>
</span></span><span style="display:flex"><span>    - parser:
</span></span><span style="display:flex"><span>        remove_key_name_field: <span style="color:#204a87">true</span>
</span></span><span style="display:flex"><span>        reserve_data: <span style="color:#204a87">true</span>
</span></span><span style="display:flex"><span>        parse:
</span></span><span style="display:flex"><span>          type: nginx
</span></span><span style="display:flex"><span>  match:
</span></span><span style="display:flex"><span>    - <span style="color:#204a87;font-weight:700">select</span>:
</span></span><span style="display:flex"><span>        labels:
</span></span><span style="display:flex"><span>          app.kubernetes.io/name: log-generator
</span></span><span style="display:flex"><span>  localOutputRefs:
</span></span><span style="display:flex"><span>    - cloudwatch-output
</span></span><span style="display:flex"><span>EOF
</span></span></code></pre></div></li><li>
<p>Install log-generator to produce logs with the label <code>app.kubernetes.io/name: log-generator</code></p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>helm upgrade --install --wait --create-namespace --namespace logging log-generator kube-logging/log-generator
</span></span></code></pre></div></li><li>
<p><a href="#validate">Validate your deployment</a>.</p></li></ol><h2 id="validate">Validate the deployment</h2><p align="center"><img src="../../img/cw.png" width="660"></p><blockquote>
<p>If you don&rsquo;t get the expected result you can find help in the <a href="/docs/operation/troubleshooting/">troubleshooting section</a>.</p></blockquote></div><div class="td-content" style="page-break-before:always">
<h1 id="pg-151681c15ceae7e696e0c20fe51220fa">3 - Splunk operator with Logging operator</h1><p align="center"><img src="../../img/splunk.png" width="340"></p><p>This guide describes how to collect application and container logs in Kubernetes using the Logging operator, and how to send them to Splunk.</p><p>Logging operator collects the logs from the application, selects which logs to forward to the output, and sends the selected log messages to the output (in this case, to Splunk). For more details about the Logging operator, see the <a href="/docs/">Logging operator overview</a>.</p><h2 id="deploy-splunk">Deploy Splunk</h2><p>First, deploy Splunk Standalone in your Kubernetes cluster. The following procedure is based on the <a href="https://www.splunk.com/en_us/blog/it/an-insider-s-guide-to-splunk-on-containers-and-kubernetes.html">Splunk on Kubernetes quickstart</a>.</p><ol>
<li>
<p>Create the <code>logging</code> Namespace.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl create ns logging
</span></span></code></pre></div></li><li>
<p>Install the Splunk operator.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#000">kubectl apply -n logging -f https://tiny.cc/splunk-operator-install</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div></li><li>
<p>Install the Splunk cluster.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#000">kubectl apply -n logging -f - &lt;&lt;&#34;EOF&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">apiVersion</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">enterprise.splunk.com/v1alpha2</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">kind</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Standalone</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">metadata</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">single</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">spec</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">config</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">splunkPassword</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">helloworld456</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">splunkStartArgs</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>--<span style="color:#000">accept-license</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">topology</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">standalones</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:700">1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">EOF</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div></li></ol><h2 id="deploy-the-logging-operator-and-a-demo-application">Deploy the Logging operator and a demo Application</h2><p>Install the Logging operator and a demo application to provide sample log messages.</p><h3 id="helm">Deploy the Logging operator with Helm</h3><p>To install the Logging operator using Helm, see <a href="/docs/install/#helm">Deploy the Logging operator with Helm</a>.</p><ol>
<li>
<p>Create the <code>logging</code> resource.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl -n logging apply -f - &lt;&lt;<span style="color:#4e9a06">&#34;EOF&#34;</span>
</span></span><span style="display:flex"><span>apiVersion: logging.banzaicloud.io/v1beta1
</span></span><span style="display:flex"><span>kind: Logging
</span></span><span style="display:flex"><span>metadata:
</span></span><span style="display:flex"><span>  name: default-logging-simple
</span></span><span style="display:flex"><span>spec:
</span></span><span style="display:flex"><span>  fluentd: <span style="color:#ce5c00;font-weight:700">{}</span>
</span></span><span style="display:flex"><span>  fluentbit: <span style="color:#ce5c00;font-weight:700">{}</span>
</span></span><span style="display:flex"><span>  controlNamespace: logging
</span></span><span style="display:flex"><span>EOF
</span></span></code></pre></div><blockquote>
<p>Note: You can use the <code>ClusterOutput</code> and <code>ClusterFlow</code> resources only in the <code>controlNamespace</code>.</p></blockquote></li><li>
<p>Get a Splunk HEC Token.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span><span style="color:#000">HEC_TOKEN</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#204a87;font-weight:700">$(</span>kubectl get secret -n logging  splunk-single-standalone-secrets -o <span style="color:#000">jsonpath</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#39;{.data.hec_token}&#39;</span> <span style="color:#000;font-weight:700">|</span> base64 --decode<span style="color:#204a87;font-weight:700">)</span>
</span></span></code></pre></div></li><li>
<p>Create a Splunk output secret from the token.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl  create secret generic splunk-token -n logging --from-literal <span style="color:#4e9a06">&#34;SplunkHecToken=</span><span style="color:#4e9a06">${</span><span style="color:#000">HEC_TOKEN</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#34;</span>
</span></span></code></pre></div></li><li>
<p>Define a Splunk <code>output</code>.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl -n logging apply -f - &lt;&lt;<span style="color:#4e9a06">&#34;EOF&#34;</span>
</span></span><span style="display:flex"><span>apiVersion: logging.banzaicloud.io/v1beta1
</span></span><span style="display:flex"><span>kind: Output
</span></span><span style="display:flex"><span>metadata:
</span></span><span style="display:flex"><span> name: splunk-output
</span></span><span style="display:flex"><span>spec:
</span></span><span style="display:flex"><span> splunkHec:
</span></span><span style="display:flex"><span>    hec_host: splunk-single-standalone-headless
</span></span><span style="display:flex"><span>    insecure_ssl: <span style="color:#204a87">true</span>
</span></span><span style="display:flex"><span>    hec_port: <span style="color:#0000cf;font-weight:700">8088</span>
</span></span><span style="display:flex"><span>    hec_token:
</span></span><span style="display:flex"><span>        valueFrom:
</span></span><span style="display:flex"><span>           secretKeyRef:
</span></span><span style="display:flex"><span>              name:  splunk-token
</span></span><span style="display:flex"><span>              key: SplunkHecToken
</span></span><span style="display:flex"><span>    index: main
</span></span><span style="display:flex"><span>    format:
</span></span><span style="display:flex"><span>      type: json
</span></span><span style="display:flex"><span>EOF
</span></span></code></pre></div></li><li>
<p>Create a <code>flow</code> resource.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl -n logging apply -f - &lt;&lt;<span style="color:#4e9a06">&#34;EOF&#34;</span>
</span></span><span style="display:flex"><span>apiVersion: logging.banzaicloud.io/v1beta1
</span></span><span style="display:flex"><span>kind: Flow
</span></span><span style="display:flex"><span>metadata:
</span></span><span style="display:flex"><span>  name: splunk-flow
</span></span><span style="display:flex"><span>spec:
</span></span><span style="display:flex"><span>  filters:
</span></span><span style="display:flex"><span>    - tag_normaliser: <span style="color:#ce5c00;font-weight:700">{}</span>
</span></span><span style="display:flex"><span>    - parser:
</span></span><span style="display:flex"><span>        remove_key_name_field: <span style="color:#204a87">true</span>
</span></span><span style="display:flex"><span>        reserve_data: <span style="color:#204a87">true</span>
</span></span><span style="display:flex"><span>        parse:
</span></span><span style="display:flex"><span>          type: nginx
</span></span><span style="display:flex"><span>  match:
</span></span><span style="display:flex"><span>    - <span style="color:#204a87;font-weight:700">select</span>:
</span></span><span style="display:flex"><span>        labels:
</span></span><span style="display:flex"><span>          app.kubernetes.io/name: log-generator
</span></span><span style="display:flex"><span>  localOutputRefs:
</span></span><span style="display:flex"><span>    - splunk-output
</span></span><span style="display:flex"><span>EOF
</span></span></code></pre></div></li><li>
<p>Install log-generator to produce logs with the label <code>app.kubernetes.io/name: log-generator</code></p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>helm upgrade --install --wait --create-namespace --namespace logging log-generator kube-logging/log-generator
</span></span></code></pre></div></li><li>
<p><a href="#validate">Validate your deployment</a>.</p></li></ol><h2 id="validate">Validate the deployment</h2><p>To validate that the deployment was successful, complete the following steps.</p><ol>
<li>
<p>Use the following command to retrieve the password of the <code>admin</code> user:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl -n logging get secret splunk-single-standalone-secrets -o <span style="color:#000">jsonpath</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#39;{.data.password}&#39;</span> <span style="color:#000;font-weight:700">|</span> base64 --decode
</span></span></code></pre></div></li><li>
<p>Enable port forwarding to the Splunk Dashboard Service.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl -n logging port-forward svc/splunk-single-standalone-headless <span style="color:#0000cf;font-weight:700">8000</span>
</span></span></code></pre></div></li><li>
<p>Open the Splunk dashboard in your browser: <a href="http://localhost:8000">http://localhost:8000</a>. You should see the dashboard and some sample log messages from the demo application.</p></li></ol><p align="center"><img src="../../img/splunk_dash.png" width="660"></p><blockquote>
<p>If you don&rsquo;t get the expected result you can find help in the <a href="/docs/operation/troubleshooting/">troubleshooting section</a>.</p></blockquote></div><div class="td-content" style="page-break-before:always">
<h1 id="pg-256fcfd7514994ffef95721e2aab59da">4 - Sumo Logic with Logging operator and Fluentd</h1><p>This guide walks you through a simple Sumo Logic setup using the Logging Operator.
Sumo Logic has Prometheus and logging capabilities as well. Now we only focus on the logging part.</p><h2 id="configuration">Configuration</h2><p>There are 3 crucial plugins needed for a proper Sumo Logic setup.</p><ol>
<li>Kubernetes metadata enhancer</li><li>Sumo Logic filter</li><li>Sumo Logic output</li></ol><p>Let&rsquo;s setup the logging first.</p><h3 id="globalfilters">GlobalFilters</h3><p>The first thing we need to ensure is that the <code>EnhanceK8s</code> filter is present in the <code>globalFilters</code> section of the Logging spec.
This adds additional data to the log lines (like deployment and service names).</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl apply -f - &lt;&lt;<span style="color:#4e9a06">&#34;EOF&#34;</span>
</span></span><span style="display:flex"><span>apiVersion: logging.banzaicloud.io/v1beta1
</span></span><span style="display:flex"><span>kind: Logging
</span></span><span style="display:flex"><span>metadata:
</span></span><span style="display:flex"><span>  name: sumologic
</span></span><span style="display:flex"><span>spec:
</span></span><span style="display:flex"><span>  controlNamespace: logging
</span></span><span style="display:flex"><span>  enableRecreateWorkloadOnImmutableFieldChange: <span style="color:#204a87">true</span>
</span></span><span style="display:flex"><span>  globalFilters:
</span></span><span style="display:flex"><span>  - enhanceK8s: <span style="color:#ce5c00;font-weight:700">{}</span>
</span></span><span style="display:flex"><span>  fluentbit:
</span></span><span style="display:flex"><span>    bufferStorage:
</span></span><span style="display:flex"><span>      storage.backlog.mem_limit: 256KB
</span></span><span style="display:flex"><span>    inputTail:
</span></span><span style="display:flex"><span>      Mem_Buf_Limit: 256KB
</span></span><span style="display:flex"><span>      storage.type: filesystem
</span></span><span style="display:flex"><span>    metrics:
</span></span><span style="display:flex"><span>      serviceMonitor: <span style="color:#204a87">true</span>
</span></span><span style="display:flex"><span>      serviceMonitorConfig: <span style="color:#ce5c00;font-weight:700">{}</span>
</span></span><span style="display:flex"><span>  fluentd:
</span></span><span style="display:flex"><span>    disablePvc: <span style="color:#204a87">true</span>
</span></span><span style="display:flex"><span>    metrics:
</span></span><span style="display:flex"><span>      serviceMonitor: <span style="color:#204a87">true</span>
</span></span><span style="display:flex"><span>      serviceMonitorConfig: <span style="color:#ce5c00;font-weight:700">{}</span>
</span></span><span style="display:flex"><span>EOF
</span></span></code></pre></div><h3 id="clusterflow">ClusterFlow</h3><p>Now we can create a ClusterFlow. Add the Sumo Logic filter to the <code>filters</code> section of the ClusterFlow spec.
It will use the Kubernetes metadata and moves them to a special field called <code>_sumo_metadata</code>.
All those moved fields will be sent as HTTP Header to the Sumo Logic endpoint.</p><blockquote>
<p>Note: As we are using Fluent Bit to enrich Kubernetes metadata, we need to specify the field names where this data is stored.</p></blockquote><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl -n logging apply -f - &lt;&lt;<span style="color:#4e9a06">&#34;EOF&#34;</span>
</span></span><span style="display:flex"><span>apiVersion: logging.banzaicloud.io/v1beta1
</span></span><span style="display:flex"><span>kind: ClusterFlow
</span></span><span style="display:flex"><span>metadata:
</span></span><span style="display:flex"><span>  name: sumologic
</span></span><span style="display:flex"><span>spec:
</span></span><span style="display:flex"><span>  filters:
</span></span><span style="display:flex"><span>    - sumologic:
</span></span><span style="display:flex"><span>        source_name: kubernetes
</span></span><span style="display:flex"><span>        log_format: fields
</span></span><span style="display:flex"><span>        tracing_namespace: namespace_name
</span></span><span style="display:flex"><span>        tracing_pod: pod_name
</span></span><span style="display:flex"><span>  match:
</span></span><span style="display:flex"><span>  - <span style="color:#204a87;font-weight:700">select</span>: <span style="color:#ce5c00;font-weight:700">{}</span>
</span></span><span style="display:flex"><span>  globalOutputRefs:
</span></span><span style="display:flex"><span>    - sumo
</span></span><span style="display:flex"><span>EOF
</span></span></code></pre></div><h3 id="clusteroutput">ClusterOutput</h3><p>Create a Sumo Logic output secret from the URL.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl create secret generic logging-sumo -n logging --from-literal <span style="color:#4e9a06">&#34;sumoURL=https://endpoint1.collection.eu.sumologic.com/......&#34;</span>
</span></span></code></pre></div><p>Finally create the Sumo Logic output.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl -n logging apply -f - &lt;&lt;<span style="color:#4e9a06">&#34;EOF&#34;</span>
</span></span><span style="display:flex"><span>apiVersion: logging.banzaicloud.io/v1beta1
</span></span><span style="display:flex"><span>kind: ClusterOutput
</span></span><span style="display:flex"><span>metadata:
</span></span><span style="display:flex"><span>  name: sumo
</span></span><span style="display:flex"><span>spec:
</span></span><span style="display:flex"><span>  sumologic:
</span></span><span style="display:flex"><span>    buffer:
</span></span><span style="display:flex"><span>      flush_interval: 10s
</span></span><span style="display:flex"><span>      flush_mode: interval
</span></span><span style="display:flex"><span>    endpoint:
</span></span><span style="display:flex"><span>      valueFrom:
</span></span><span style="display:flex"><span>        secretKeyRef:
</span></span><span style="display:flex"><span>          name:  logging-sumo
</span></span><span style="display:flex"><span>          key: sumoURL
</span></span><span style="display:flex"><span>    source_name: kubernetes
</span></span><span style="display:flex"><span>EOF
</span></span></code></pre></div></div><div class="td-content" style="page-break-before:always">
<h1 id="pg-abd97e700fb7a973b1dcfb4cb9aae1b4">5 - Transport Nginx Access Logs into Kafka with Logging operator</h1><p align="center"><img src="../../img/kafka_logo.png" width="340"></p><p>This guide describes how to collect application and container logs in Kubernetes using the Logging operator, and how to send them to Kafka.</p><p>The following figure gives you an overview about how the system works. The Logging operator collects the logs from the application, selects which logs to forward to the output, and sends the selected log messages to the output. For more details about the Logging operator, see the <a href="/docs/">Logging operator overview</a>.</p><p align="center"><img src="../../img/nignx-kafka.png" width="900"></p><h2 id="deploy-kafka">Deploy Kafka</h2><p>This demo uses <a href="https://github.com/banzaicloud/koperator/">Koperator</a> to create an Apache Kafka cluster in Kubernetes. For details on installing it, see the <a href="https://banzaicloud.com/docs/supertubes/kafka-operator/install-kafka-operator/">Koperator installation guide</a>.</p><h2 id="deploy-the-logging-operator-and-a-demo-application">Deploy the Logging operator and a demo Application</h2><p>Install the Logging operator and a demo application to provide sample log messages.</p><h3 id="helm">Deploy the Logging operator with Helm</h3><p>To install the Logging operator using Helm, complete these steps.</p><blockquote>
<p>Note: For the Helm-based installation you need Helm v3.2.1 or later.</p></blockquote><ol>
<li>
<p>Add the chart repository of the Logging operator using the following commands:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>helm repo add kube-logging https://kube-logging.dev/helm-charts
</span></span><span style="display:flex"><span>helm repo update
</span></span></code></pre></div></li><li>
<p>Install the Logging operator into the <em>logging</em> namespace:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>helm upgrade --install --wait --create-namespace --namespace logging logging-operator kube-logging/logging-operator
</span></span></code></pre></div></li><li>
<p><a href="#validate">Validate your deployment</a>.</p></li><li>
<p>Create the <code>logging</code> resource.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#000">kubectl -n logging apply -f - &lt;&lt;&#34;EOF&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">apiVersion</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">logging.banzaicloud.io/v1beta1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">kind</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Logging</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">metadata</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">default-logging-simple</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">spec</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">fluentd</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">fluentbit</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">controlNamespace</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">logging</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">EOF</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><blockquote>
<p>Note: You can use the <code>ClusterOutput</code> and <code>ClusterFlow</code> resources only in the <code>controlNamespace</code>.</p></blockquote></li><li>
<p>Create a Kafka <code>output</code> definition.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#000">kubectl -n logging apply -f - &lt;&lt;&#34;EOF&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">apiVersion</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">logging.banzaicloud.io/v1beta1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">kind</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Output</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">metadata</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kafka-output</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">spec</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:700">kafka</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#204a87;font-weight:700">brokers</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kafka-headless.kafka.svc.cluster.local:29092</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#204a87;font-weight:700">default_topic</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">topic</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#204a87;font-weight:700">format</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#204a87;font-weight:700">type</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">json</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#204a87;font-weight:700">buffer</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#204a87;font-weight:700">tags</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">topic</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#204a87;font-weight:700">timekey</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">1m</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#204a87;font-weight:700">timekey_wait</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">30s</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#204a87;font-weight:700">timekey_use_utc</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:700">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">EOF</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><blockquote>
<p>Note: In production environment, use a longer <code>timekey</code> interval to avoid generating too many objects.</p></blockquote></li><li>
<p>Create a <code>flow</code> resource.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#000">kubectl -n logging apply -f - &lt;&lt;&#34;EOF&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">apiVersion</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">logging.banzaicloud.io/v1beta1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">kind</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Flow</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">metadata</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kafka-flow</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">spec</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">filters</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:700">tag_normaliser</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:700">parser</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">remove_key_name_field</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:700">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">reserve_data</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:700">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">parse</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:700">type</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nginx</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">match</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:700">select</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">labels</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:700">app.kubernetes.io/name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">log-generator</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">localOutputRefs</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#000">kafka-output</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">EOF</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div></li><li>
<p>Install log-generator to produce logs with the label <code>app.kubernetes.io/name: log-generator</code></p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>helm upgrade --install --wait --create-namespace --namespace logging log-generator kube-logging/log-generator
</span></span></code></pre></div></li><li>
<p><a href="#validate">Validate your deployment</a>.</p></li></ol><h2 id="validate">Validate the deployment</h2><p>Run the following command to consume some log messages from Kafka:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl -n kafka run kafka-consumer -it --image<span style="color:#ce5c00;font-weight:700">=</span>banzaicloud/kafka:2.13-2.4.0 --rm<span style="color:#ce5c00;font-weight:700">=</span><span style="color:#204a87">true</span> --restart<span style="color:#ce5c00;font-weight:700">=</span>Never -- /opt/kafka/bin/kafka-console-consumer.sh --bootstrap-server kafka-headless:29092 --topic topic --from-beginning
</span></span></code></pre></div><p>Expected output:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span><span style="color:#ce5c00;font-weight:700">{</span><span style="color:#4e9a06">&#34;stream&#34;</span>:<span style="color:#4e9a06">&#34;stdout&#34;</span>,<span style="color:#4e9a06">&#34;logtag&#34;</span>:<span style="color:#4e9a06">&#34;F&#34;</span>,<span style="color:#4e9a06">&#34;kubernetes&#34;</span>:<span style="color:#ce5c00;font-weight:700">{</span><span style="color:#4e9a06">&#34;pod_name&#34;</span>:<span style="color:#4e9a06">&#34;logging-demo-log-generator-5f9f9cdb9f-z76wr&#34;</span>,<span style="color:#4e9a06">&#34;namespace_name&#34;</span>:<span style="color:#4e9a06">&#34;logging&#34;</span>,<span style="color:#4e9a06">&#34;pod_id&#34;</span>:<span style="color:#4e9a06">&#34;a7174256-31bf-4ace-897b-77899873d9ad&#34;</span>,<span style="color:#4e9a06">&#34;labels&#34;</span>:<span style="color:#ce5c00;font-weight:700">{</span><span style="color:#4e9a06">&#34;app.kubernetes.io/instance&#34;</span>:<span style="color:#4e9a06">&#34;logging-demo&#34;</span>,<span style="color:#4e9a06">&#34;app.kubernetes.io/name&#34;</span>:<span style="color:#4e9a06">&#34;log-generator&#34;</span>,<span style="color:#4e9a06">&#34;pod-template-hash&#34;</span>:<span style="color:#4e9a06">&#34;5f9f9cdb9f&#34;</span><span style="color:#ce5c00;font-weight:700">}</span>,<span style="color:#4e9a06">&#34;host&#34;</span>:<span style="color:#4e9a06">&#34;ip-192-168-3-189.eu-west-2.compute.internal&#34;</span>,<span style="color:#4e9a06">&#34;container_name&#34;</span>:<span style="color:#4e9a06">&#34;log-generator&#34;</span>,<span style="color:#4e9a06">&#34;docker_id&#34;</span>:<span style="color:#4e9a06">&#34;7349e6bb2926b8c93cb054a60f171a3f2dd1f6751c07dd389da7f28daf4d70c5&#34;</span>,<span style="color:#4e9a06">&#34;container_hash&#34;</span>:<span style="color:#4e9a06">&#34;ghcr.io/banzaicloud/log-generator@sha256:814a69be8ab8a67aa6b009d83f6fa6c4776beefbe629a869ff16690fde8ac362&#34;</span>,<span style="color:#4e9a06">&#34;container_image&#34;</span>:<span style="color:#4e9a06">&#34;ghcr.io/banzaicloud/log-generator:0.3.3&#34;</span><span style="color:#ce5c00;font-weight:700">}</span>,<span style="color:#4e9a06">&#34;remote&#34;</span>:<span style="color:#4e9a06">&#34;79.104.42.168&#34;</span>,<span style="color:#4e9a06">&#34;host&#34;</span>:<span style="color:#4e9a06">&#34;-&#34;</span>,<span style="color:#4e9a06">&#34;user&#34;</span>:<span style="color:#4e9a06">&#34;-&#34;</span>,<span style="color:#4e9a06">&#34;method&#34;</span>:<span style="color:#4e9a06">&#34;PUT&#34;</span>,<span style="color:#4e9a06">&#34;path&#34;</span>:<span style="color:#4e9a06">&#34;/products&#34;</span>,<span style="color:#4e9a06">&#34;code&#34;</span>:<span style="color:#4e9a06">&#34;302&#34;</span>,<span style="color:#4e9a06">&#34;size&#34;</span>:<span style="color:#4e9a06">&#34;18136&#34;</span>,<span style="color:#4e9a06">&#34;referer&#34;</span>:<span style="color:#4e9a06">&#34;-&#34;</span>,<span style="color:#4e9a06">&#34;agent&#34;</span>:<span style="color:#4e9a06">&#34;Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/33.0.1750.166 Safari/537.36 OPR/20.0.1396.73172&#34;</span>,<span style="color:#4e9a06">&#34;http_x_forwarded_for&#34;</span>:<span style="color:#4e9a06">&#34;-&#34;</span><span style="color:#ce5c00;font-weight:700">}</span>
</span></span><span style="display:flex"><span><span style="color:#ce5c00;font-weight:700">{</span><span style="color:#4e9a06">&#34;stream&#34;</span>:<span style="color:#4e9a06">&#34;stdout&#34;</span>,<span style="color:#4e9a06">&#34;logtag&#34;</span>:<span style="color:#4e9a06">&#34;F&#34;</span>,<span style="color:#4e9a06">&#34;kubernetes&#34;</span>:<span style="color:#ce5c00;font-weight:700">{</span><span style="color:#4e9a06">&#34;pod_name&#34;</span>:<span style="color:#4e9a06">&#34;logging-demo-log-generator-5f9f9cdb9f-mpp98&#34;</span>,<span style="color:#4e9a06">&#34;namespace_name&#34;</span>:<span style="color:#4e9a06">&#34;logging&#34;</span>,<span style="color:#4e9a06">&#34;pod_id&#34;</span>:<span style="color:#4e9a06">&#34;e2822c26-961c-4be8-99a2-b17517494ca1&#34;</span>,<span style="color:#4e9a06">&#34;labels&#34;</span>:<span style="color:#ce5c00;font-weight:700">{</span><span style="color:#4e9a06">&#34;app.kubernetes.io/instance&#34;</span>:<span style="color:#4e9a06">&#34;logging-demo&#34;</span>,<span style="color:#4e9a06">&#34;app.kubernetes.io/name&#34;</span>:<span style="color:#4e9a06">&#34;log-generator&#34;</span>,<span style="color:#4e9a06">&#34;pod-template-hash&#34;</span>:<span style="color:#4e9a06">&#34;5f9f9cdb9f&#34;</span><span style="color:#ce5c00;font-weight:700">}</span>,<span style="color:#4e9a06">&#34;host&#34;</span>:<span style="color:#4e9a06">&#34;ip-192-168-2-102.eu-west-2.compute.internal&#34;</span>,<span style="color:#4e9a06">&#34;container_name&#34;</span>:<span style="color:#4e9a06">&#34;log-generator&#34;</span>,<span style="color:#4e9a06">&#34;docker_id&#34;</span>:<span style="color:#4e9a06">&#34;26ffbec769e52e468216fe43a331f4ce5374075f9b2717d9b9ae0a7f0747b3e2&#34;</span>,<span style="color:#4e9a06">&#34;container_hash&#34;</span>:<span style="color:#4e9a06">&#34;ghcr.io/banzaicloud/log-generator@sha256:814a69be8ab8a67aa6b009d83f6fa6c4776beefbe629a869ff16690fde8ac362&#34;</span>,<span style="color:#4e9a06">&#34;container_image&#34;</span>:<span style="color:#4e9a06">&#34;ghcr.io/banzaicloud/log-generator:0.3.3&#34;</span><span style="color:#ce5c00;font-weight:700">}</span>,<span style="color:#4e9a06">&#34;remote&#34;</span>:<span style="color:#4e9a06">&#34;26.220.126.5&#34;</span>,<span style="color:#4e9a06">&#34;host&#34;</span>:<span style="color:#4e9a06">&#34;-&#34;</span>,<span style="color:#4e9a06">&#34;user&#34;</span>:<span style="color:#4e9a06">&#34;-&#34;</span>,<span style="color:#4e9a06">&#34;method&#34;</span>:<span style="color:#4e9a06">&#34;POST&#34;</span>,<span style="color:#4e9a06">&#34;path&#34;</span>:<span style="color:#4e9a06">&#34;/&#34;</span>,<span style="color:#4e9a06">&#34;code&#34;</span>:<span style="color:#4e9a06">&#34;200&#34;</span>,<span style="color:#4e9a06">&#34;size&#34;</span>:<span style="color:#4e9a06">&#34;14370&#34;</span>,<span style="color:#4e9a06">&#34;referer&#34;</span>:<span style="color:#4e9a06">&#34;-&#34;</span>,<span style="color:#4e9a06">&#34;agent&#34;</span>:<span style="color:#4e9a06">&#34;Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:52.0) Gecko/20100101 Firefox/52.0&#34;</span>,<span style="color:#4e9a06">&#34;http_x_forwarded_for&#34;</span>:<span style="color:#4e9a06">&#34;-&#34;</span><span style="color:#ce5c00;font-weight:700">}</span>
</span></span></code></pre></div><blockquote>
<p>If you don&rsquo;t get the expected result you can find help in the <a href="/docs/operation/troubleshooting/">troubleshooting section</a>.</p></blockquote></div><div class="td-content" style="page-break-before:always">
<h1 id="pg-01af43cb645f47605cedaae3bc91678b">6 - Store Nginx Access Logs in Grafana Loki with Logging operator</h1><p align="center"><img src="../../img/nll.png" width="340"></p><p>This guide describes how to collect application and container logs in Kubernetes using the Logging operator, and how to send them to Grafana Loki.</p><p>The following figure gives you an overview about how the system works. The Logging operator collects the logs from the application, selects which logs to forward to the output, and sends the selected log messages to the output. For more details about the Logging operator, see the <a href="/docs/">Logging operator overview</a>.</p><p align="center"><img src="../../img/nginx-loki.png" width="900"></p><h2 id="deploy-loki-and-grafana">Deploy Loki and Grafana</h2><ol>
<li>
<p>Add the chart repositories of Loki and Grafana using the following commands:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>helm repo add grafana https://grafana.github.io/helm-charts
</span></span><span style="display:flex"><span>helm repo add loki https://grafana.github.io/loki/charts
</span></span><span style="display:flex"><span>helm repo update
</span></span></code></pre></div></li><li>
<p>Install Loki into the <em>logging</em> namespace:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>helm upgrade --install --create-namespace --namespace logging loki loki/loki
</span></span></code></pre></div><blockquote>
<p><a href="https://github.com/grafana/loki/tree/master/production/helm">Grafana Loki Documentation</a></p></blockquote></li><li>
<p>Install Grafana into the <em>logging</em> namespace:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span> helm upgrade --install --create-namespace --namespace logging grafana grafana/grafana <span style="color:#4e9a06">\
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06"></span> --set <span style="color:#4e9a06">&#34;datasources.datasources\\.yaml.apiVersion=1&#34;</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06"></span> --set <span style="color:#4e9a06">&#34;datasources.datasources\\.yaml.datasources[0].name=Loki&#34;</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06"></span> --set <span style="color:#4e9a06">&#34;datasources.datasources\\.yaml.datasources[0].type=loki&#34;</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06"></span> --set <span style="color:#4e9a06">&#34;datasources.datasources\\.yaml.datasources[0].url=http://loki:3100&#34;</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06"></span> --set <span style="color:#4e9a06">&#34;datasources.datasources\\.yaml.datasources[0].access=proxy&#34;</span>
</span></span></code></pre></div></li></ol><h2 id="deploy-the-logging-operator-and-a-demo-application">Deploy the Logging operator and a demo application</h2><p>Install the Logging operator and a demo application to provide sample log messages.</p><h3 id="helm">Deploy the Logging operator with Helm</h3><p>To install the Logging operator using Helm, complete these steps.</p><blockquote>
<p>Note: For the Helm-based installation you need Helm v3.2.1 or later.</p></blockquote><ol>
<li>
<p>Add the chart repository of the Logging operator using the following commands:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>helm repo add kube-logging https://kube-logging.dev/helm-charts
</span></span><span style="display:flex"><span>helm repo update
</span></span></code></pre></div></li><li>
<p>Install the Logging operator into the <em>logging</em> namespace:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>helm upgrade --install --wait --create-namespace --namespace logging logging-operator kube-logging/logging-operator
</span></span></code></pre></div></li><li>
<p>Create the <code>logging</code> resource.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl -n logging apply -f - &lt;&lt;<span style="color:#4e9a06">&#34;EOF&#34;</span>
</span></span><span style="display:flex"><span>apiVersion: logging.banzaicloud.io/v1beta1
</span></span><span style="display:flex"><span>kind: Logging
</span></span><span style="display:flex"><span>metadata:
</span></span><span style="display:flex"><span>  name: default-logging-simple
</span></span><span style="display:flex"><span>spec:
</span></span><span style="display:flex"><span>  fluentd: <span style="color:#ce5c00;font-weight:700">{}</span>
</span></span><span style="display:flex"><span>  fluentbit: <span style="color:#ce5c00;font-weight:700">{}</span>
</span></span><span style="display:flex"><span>  controlNamespace: logging
</span></span><span style="display:flex"><span>EOF
</span></span></code></pre></div><blockquote>
<p>Note: You can use the <code>ClusterOutput</code> and <code>ClusterFlow</code> resources only in the <code>controlNamespace</code>.</p></blockquote></li><li>
<p>Create a Loki <code>output</code> definition.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl -n logging apply -f - &lt;&lt;<span style="color:#4e9a06">&#34;EOF&#34;</span>
</span></span><span style="display:flex"><span>apiVersion: logging.banzaicloud.io/v1beta1
</span></span><span style="display:flex"><span>kind: Output
</span></span><span style="display:flex"><span>metadata:
</span></span><span style="display:flex"><span> name: loki-output
</span></span><span style="display:flex"><span>spec:
</span></span><span style="display:flex"><span> loki:
</span></span><span style="display:flex"><span>   url: http://loki:3100
</span></span><span style="display:flex"><span>   configure_kubernetes_labels: <span style="color:#204a87">true</span>
</span></span><span style="display:flex"><span>   buffer:
</span></span><span style="display:flex"><span>     timekey: 1m
</span></span><span style="display:flex"><span>     timekey_wait: 30s
</span></span><span style="display:flex"><span>     timekey_use_utc: <span style="color:#204a87">true</span>
</span></span><span style="display:flex"><span>EOF
</span></span></code></pre></div><blockquote>
<p>Note: In production environment, use a longer <code>timekey</code> interval to avoid generating too many objects.</p></blockquote></li><li>
<p>Create a <code>flow</code> resource.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl -n logging apply -f - &lt;&lt;<span style="color:#4e9a06">&#34;EOF&#34;</span>
</span></span><span style="display:flex"><span>apiVersion: logging.banzaicloud.io/v1beta1
</span></span><span style="display:flex"><span>kind: Flow
</span></span><span style="display:flex"><span>metadata:
</span></span><span style="display:flex"><span>  name: loki-flow
</span></span><span style="display:flex"><span>spec:
</span></span><span style="display:flex"><span>  filters:
</span></span><span style="display:flex"><span>    - tag_normaliser: <span style="color:#ce5c00;font-weight:700">{}</span>
</span></span><span style="display:flex"><span>    - parser:
</span></span><span style="display:flex"><span>        remove_key_name_field: <span style="color:#204a87">true</span>
</span></span><span style="display:flex"><span>        reserve_data: <span style="color:#204a87">true</span>
</span></span><span style="display:flex"><span>        parse:
</span></span><span style="display:flex"><span>          type: nginx
</span></span><span style="display:flex"><span>  match:
</span></span><span style="display:flex"><span>    - <span style="color:#204a87;font-weight:700">select</span>:
</span></span><span style="display:flex"><span>        labels:
</span></span><span style="display:flex"><span>          app.kubernetes.io/name: log-generator
</span></span><span style="display:flex"><span>  localOutputRefs:
</span></span><span style="display:flex"><span>    - loki-output
</span></span><span style="display:flex"><span>EOF
</span></span></code></pre></div></li><li>
<p>Install log-generator to produce logs with the label <code>app.kubernetes.io/name: log-generator</code></p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>helm upgrade --install --wait --create-namespace --namespace logging log-generator kube-logging/log-generator
</span></span></code></pre></div></li><li>
<p><a href="#validate">Validate your deployment</a>.</p></li></ol><h2 id="validate">Validate the deployment</h2><h3 id="grafana-dashboard">Grafana Dashboard</h3><ol>
<li>
<p>Use the following command to retrieve the password of the Grafana <code>admin</code> user:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl get secret --namespace logging grafana -o <span style="color:#000">jsonpath</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#34;{.data.admin-password}&#34;</span> <span style="color:#000;font-weight:700">|</span> base64 --decode <span style="color:#000;font-weight:700">;</span> <span style="color:#204a87">echo</span>
</span></span></code></pre></div></li><li>
<p>Enable port forwarding to the Grafana Service.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl -n logging port-forward svc/grafana 3000:80
</span></span></code></pre></div></li><li>
<p>Open the Grafana Dashboard: <a href="http://localhost:3000">http://localhost:3000</a></p></li><li>
<p>Use the <code>admin</code> username and the password retrieved in Step 1 to log in.</p></li><li>
<p>Select <strong>Menu > Explore</strong>, select <strong>Data source > Loki</strong>, then select <strong>Log labels > namespace > logging</strong>. A list of logs should appear.</p><p><img src="../../img/loki1.png" alt="Sample log messages in Loki"></p></li></ol><blockquote>
<p>If you don&rsquo;t get the expected result you can find help in the <a href="/docs/operation/troubleshooting/">troubleshooting section</a>.</p></blockquote></div></main></div></div><footer class="bg-dark py-5 row d-print-none">
<div class="container-fluid mx-sm-5">
<div class="row">
<div class="col-6 col-sm-4 text-xs-center order-sm-2">
</div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
<ul class="list-inline mb-0">
<li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="GitHub" aria-label="GitHub">
<a class="text-white" target="_blank" rel="noopener" href="https://github.com/kube-logging/logging-operator" aria-label="GitHub">
<i class="fab fa-github"></i>
</a>
</li><li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Slack" aria-label="Slack">
<a class="text-white" target="_blank" rel="noopener" href="https://banzaicloud.com/invite-slack/" aria-label="Slack">
<i class="fab fa-slack"></i>
</a>
</li><li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Discord" aria-label="Discord">
<a class="text-white" target="_blank" rel="noopener" href="https://discord.gg/9ACY4RDsYN" aria-label="Discord">
<i class="fab fa-discord"></i>
</a>
</li></ul></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2">
<small class="text-white">&copy; 2023 kube-logging authors All Rights Reserved</small>
</div></div></div></footer></div><script src="/js/main.min.2aff983e9d0d8ecff9ed53e14b657216e2d8d2aff059bf4a5651283020995f1b.js" integrity="sha256-Kv+YPp0Njs/57VPhS2VyFuLY0q/wWb9KVlEoMCCZXxs=" crossorigin="anonymous"></script>
<script src='/js/prism.js'></script>
<script src='/js/tabpane-persist.js'></script>
<script src="/js/tocbot.min.js"></script>
<script type="text/javascript">tocbot.init({tocSelector:".td-toc",contentSelector:".td-content",headingSelector:"h2, h3, h4",ignoreHiddenElements:!0})</script>
</body></html>